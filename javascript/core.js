define(["log","utils","collection","entry","register","ui","db","synchronize"],function(a,b,c,d,e,f,g,h){var i=a.getLogger("core");i.info("Loading core.js");var j="6",k="xebiaFr",l="devoxxFR",m=k,n=[k,l],o={},p,q={ids:[]};g.get("favorites",function(a){a&&(q=a)});var r={events:[{id:"6",name:"Devoxx France 2012",days:[{id:"1",name:"Mercredi 18 Avril",date:"2012-04-18"},{id:"2",name:"Jeudi 19 Avril",date:"2012-04-19"},{id:"3",name:"Vendredi 20 Avril",date:"2012-04-20"}]}]};return o.getEvent=function(a){return _(r.events).find(function(b){return b.id==a})},o.getDay=function(a,b){return _(a.days).find(function(a){return a.id==b})},o.addUrlsForEvent=function(a){h.addUrl("/events/"+a+"/schedule",b.getFullUrl("/events/"+a+"/schedule?callback=?")),h.addUrl("/events/"+a+"/presentations",b.getFullUrl("/events/"+a+"/presentations?callback=?")),h.addUrl("/events/"+a+"/schedule/rooms",b.getFullUrl("/events/"+a+"/schedule/rooms?callback=?")),h.addUrl("/events/"+a+"/tracks",b.getFullUrl("/events/"+a+"/tracks?callback=?")),h.addUrl("/events/"+a+"/speakers",b.getFullUrl("/events/"+a+"/speakers?callback=?")),h.addUrl("/events",b.getFullUrl("/events?callback=?"))},o.setupRouter=function(){i.info("Instanciating jqmr router"),p=new $.mobile.Router({"#schedule":{handler:"onBeforeSchedulePageShow",events:"bs"},"#day(?:[?](.*))":{handler:"onBeforeDayPageShow",events:"bs"},"#events":{handler:"onBeforeEventsPageShow",events:"bs"},"#event(?:[?](.*))":{handler:"onBeforeEventPageShow",events:"bs"},"#rooms":{handler:"onBeforeRoomsPageShow",events:"bs"},"#room(?:[?](.*))":{handler:"onBeforeRoomPageShow",events:"bs"},"#presentations":{handler:"onBeforePresentationsPageShow",events:"bs"},"#presentation(?:[?](.*))":{handler:"onBeforePresentationPageShow",events:"bs"},"#speakers":{handler:"onBeforeSpeakersPageShow",events:"bs"},"#speaker(?:[?](.*))":{handler:"onBeforeSpeakerPageShow",events:"bs"},"#tracks":{handler:"onBeforeTracksPageShow",events:"bs"},"#track(?:[?](.*))":{handler:"onBeforeTrackPageShow",events:"bs"},"#register":{handler:"onBeforeRegisterPageShow",events:"bs"},"#synchronize":{handler:"onBeforeSynchronizePageShow",events:"bs"},"#twitter(?:[?](.*))?":{handler:"onBeforeTwitterPageShow",events:"bs"},"#xebia-program":{handler:"onBeforeXebiaProgramPageShow",events:"bs"}},{onBeforeSchedulePageShow:function(a,b,c,d,e){o.refreshSchedule()},onBeforeEventsPageShow:function(a,b,c,d,e){o.refreshEvents()},onBeforeEventPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]);o.refreshEvent(f.id)},onBeforeRoomsPageShow:function(a,b,c,d,e){o.refreshRooms()},onBeforeRoomPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]);o.refreshRoom(f.id)},onBeforeTracksPageShow:function(a,b,c,d,e){o.refreshTracks()},onBeforePresentationsPageShow:function(a,b,c,d,e){o.refreshPresentations()},onBeforePresentationPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]);o.refreshPresentation(f.id)},onBeforeSpeakersPageShow:function(a,b,c,d,e){o.refreshSpeakers()},onBeforeSpeakerPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]);o.refreshSpeaker(f.id)},onBeforeTrackPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]);o.refreshTrack(f.id)},onBeforeDayPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]);o.refreshDay(f.id)},onBeforeRegisterPageShow:function(a,b,c,d,f){e.beforePageShow()},onBeforeSynchronizePageShow:function(a,b,c,d,e){h.beforePageShow()},onBeforeTwitterPageShow:function(a,b,c,d,e){var f=p.getParams(b[1]),g=f?f.screenname:undefined;o.refreshTwitter(g)},onBeforeXebiaProgramPageShow:function(a,b,c,d,e){o.refreshXebiaProgram()}}),i.info("Instanciated jqmr router")},o.onFetchSuccess=function(a,b,c){a.get("statusCode")=="404"&&f.showFlashMessage(_.extend({type:"error",message:a.get("message")},c)),setTimeout(function(){$.mobile.hidePageLoadingMsg(),f.hideFlashMessage(c)},0)},o.onFetchError=function(a,b,c,d){setTimeout(function(){i.info("Error response tmp: '"+b+"' for url: '"+d.fetchUrl+"'"),$.mobile.hidePageLoadingMsg(),f.hideFlashMessage(d),f.showFlashMessage(_.extend({type:"error",message:"No data found ..."},d))},0)},o.getParams=function(a){if(!a)return null;var b={},c,d=a.slice(a.indexOf("?")+1).split("&");return $.each(d,function(a,d){c=d.split("="),b[c[0]]?(b[c[0]]instanceof Array||(b[c[0]]=[b[c[0]]]),b[c[0]].push(c[1])):b[c[0]]=c[1]}),$.isEmptyObject(b)?null:b},o.refreshDataList=function(a){i.info("Loading "+a.title+" View"),c.views[a.view]=new c.EntryListView({fetchUrl:a.url,el:a.el,collectionTemplate:a.template,parse:a.parse,beforeParse:function(b){a.cacheKey&&!b.statusCode&&g.save(a.cacheKey,b),a.beforeParse&&a.beforeParse(b)},view:a.view,postRender:a.postRender,afterParse:function(b){a.afterParse&&a.afterParse(b)}}),c.views[a.view].collection.length!==0&&c.views[a.view].collection.reset([]),i.info("Fetch "+a.title+" Data from url: '"+c.views[a.view].collection.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),f.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),o.onFetchSuccess(b,c,a)},error:function(b,c,d){o.onFetchError(b,c,d,a)},fetchUrl:a.url};g.getOrFetch(a.cacheKey,function(b){a.beforeParse&&(b=a.beforeParse(b)),a.parse&&(b=a.parse(b)),a.afterParse&&(b=a.afterParse(b)),a.beforeReset&&a.beforeReset(b),c.views[a.view].collection.reset(b),f.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),c.views[a.view].el.empty(),c.views[a.view].collection.fetch(b)})},o.refreshDataEntry=function(a){i.info("Loading "+a.title+" View"),d.views[a.view]=new d.EntryView({fetchUrl:a.url,el:a.el,entryTemplate:a.template,parse:a.parse,beforeParse:function(b){a.cacheKey&&!b.statusCode&&g.save(a.cacheKey,b),a.beforeParse&&a.beforeParse(b)},postRender:a.postRender,view:a.view,afterParse:function(b){a.afterParse&&a.afterParse(b)}}),d.views[a.view].entry&&d.views[a.view].entry.clear(),i.info("Fetch "+a.title+" Data from url: '"+d.views[a.view].entry.url+"'");var b={onFetch:function(){$.mobile.showPageLoadingMsg(),i.info("Show "+a.title+" page message!"),f.showFlashMessage(a)},success:function(b,c){a.success&&a.success(b,c),o.onFetchSuccess(b,c,a)},error:function(b,c,d){o.onFetchError(b,c,d,a)},fetchUrl:a.url};g.getOrFetch(a.cacheKey,function(b){a.beforeParse&&(b=a.beforeParse(b)),a.parse&&(b=a.parse(b)),a.afterParse&&(b=a.afterParse(b)),a.beforeReset&&a.beforeReset(b),d.views[a.view].entry.set(b),f.hideFlashMessage(a)},function(){b.onFetch&&b.onFetch(),d.views[a.view].entry.fetch(b)})},o.refreshSchedule=function(){f.resetFlashMessages("#schedule"),f.switchTitle("Planning"),o.refreshDataList({page:"#schedule",title:"Planning",el:"#schedule-list",view:"schedule",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/schedule?callback=?"),cacheKey:"/events/"+j+"/schedule",parse:function(a){return _(a).each(function(a){a.presentationUri&&(a.key=Number(a.presentationUri.substring(a.presentationUri.lastIndexOf("/")+1)),a.favorite=q&&_(q.ids).contains(a.key)),a.startTime=o.getScheduleTime(a.fromTime),a.endTime=o.getScheduleTime(a.toTime)}),a},beforeReset:function(a){return _(a).each(function(a){a.presentationUri&&(a.favorite=q&&_(q.ids).contains(Number(a.key)))}),a},postRender:function(a){o.initSwipeFavorites("presentation-schedule-item")}})},o.refreshDay=function(a){f.resetFlashMessages("#day"),i.info("Processing day: "+a);var c="Jour "+a,d=o.getEvent(j),e;d&&(e=o.getDay(d,a),e&&(c=e.name)),f.switchTitle(c),o.refreshDataList({page:"#day",title:c,el:"#day-list",view:"day",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/schedule?callback=?"),cacheKey:"/events/"+j+"/schedule",parse:function(a){return a=_(a).filter(function(a){return e&&a.fromTime.substr(0,10)===e.date}),_(a).each(function(a){a.presentationUri&&(a.key=a.presentationUri.substring(a.presentationUri.lastIndexOf("/")+1),a.favorite=q&&_(q.ids).contains(Number(a.key))),a.startTime=o.getScheduleTime(a.fromTime),a.endTime=o.getScheduleTime(a.toTime)}),a},beforeReset:function(a){return _(a).each(function(a){a.presentationUri&&(a.favorite=q&&_(q.ids).contains(Number(a.key)))}),a},postRender:function(a){o.initSwipeFavorites("presentation-day-item")}})},o.getScheduleTime=function(a){return Date.parseExact(a.substring(0,a.lastIndexOf(".")),"yyyy-MM-dd HH:mm:ss").toString("HH:mm")},o.refreshEvents=function(){f.resetFlashMessages("#events"),i.info("Refreshing events"),f.switchTitle("Evénements"),o.refreshDataList({page:"#events",title:"Event",el:"#event-list",view:"events",template:$("#event-list-tpl").html(),url:b.getFullUrl("/events?callback=?"),cacheKey:"/events",parse:function(a){return a}})},o.refreshEvent=function(a){f.resetFlashMessages("#event"),i.info("Processing event: "+a),f.switchTitle("Evénement"),o.refreshDataEntry({page:"#event",title:"Event",el:"#event-content",view:"event",template:$("#event-tpl").html(),url:b.getFullUrl("/events?callback=?"),cacheKey:"/events",parse:function(b){var c=_(b).find(function(b){return b.id==a});return c},postRender:function(a){$("#event-details-list").listview(),f.switchTitle(a.get("name"))}})},o.refreshPresentations=function(){f.resetFlashMessages("#presentations"),i.info("Refreshing presentations"),f.switchTitle("Présentations"),o.refreshDataList({page:"#presentations",title:"Presentations",el:"#presentation-list",view:"presentation",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",parse:function(a){return _(a).each(function(a){a.language&&(a.language=a.language.toUpperCase()),a.favorite=q&&_(q.ids).contains(a.id)}),a},beforeReset:function(a){return presentation.language&&(presentation.language=presentation.language.toUpperCase()),_(a).each(function(a){a.favorite=q&&_(q.ids).contains(a.id)}),a},postRender:function(a){o.initSwipeFavorites("presentation-item")}})},o.refreshPresentation=function(a){f.resetFlashMessages("#presentation"),i.info("Processing presentation: "+a),f.switchTitle("Présentation"),o.refreshDataEntry({page:"#presentation",title:"Présentation",el:"#presentation-content",view:"presentation",template:$("#presentation-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",parse:function(b){var c=_(b).find(function(b){return b.id==a});return c.language&&(c.language=c.language.toUpperCase()),c.favorite=q&&_(q.ids).contains(c.id),c.enhanced||(c.summary=o.formatPresentationSummary(c),c.enhanced=!0),_(c.speakers).each(function(a){a.id=a.speakerUri.substring(a.speakerUri.lastIndexOf("/")+1)}),c},postRender:function(a){$("#presentation-tag-list").listview(),$("#presentation-speaker-list").listview(),$("#presentation-details-list").listview(),f.switchTitle(a.get("title"))},beforeReset:function(a){return a.favorite=q&&_(q.ids).contains(a.id),a}})},o.refreshSpeakers=function(){f.resetFlashMessages("#tracks"),i.info("Refreshing speakers"),f.switchTitle("Speakers"),o.refreshDataList({page:"#speakers",title:"Speakers",el:"#speaker-list",view:"speaker",template:$("#speaker-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/speakers?callback=?"),cacheKey:"/events/"+j+"/speakers",parse:function(a){return a}})},o.refreshSpeaker=function(a){f.resetFlashMessages("#speaker"),i.info("Processing speaker: "+a),f.switchTitle("Speaker"),o.refreshDataEntry({page:"#speaker",title:"Speaker",el:"#speaker-content",view:"speaker",template:$("#speaker-tpl").html(),url:b.getFullUrl("/events/"+j+"/speakers?callback=?"),cacheKey:"/events/"+j+"/speakers",parse:function(c){var d=_(c).find(function(b){return b.id==a});return d.enhanced||(d.bio=b.linkify(d.bio),d.enhanced=!0),_(d.talks).each(function(a){a.id=a.presentationUri.substring(a.presentationUri.lastIndexOf("/")+1)}),d},postRender:function(a){$("#speaker-details-list").listview(),$("#speaker-talk-list").listview();var b=a.get("firstName")?a.get("firstName"):"";b+=a.get("firstName")&&a.get("lastName")?" ":"",b+=a.get("lastName")?a.get("lastName"):"",f.switchTitle(b?b:"Speaker")}})},o.refreshTracks=function(){f.resetFlashMessages("#tracks"),i.info("Refreshing tracks"),f.switchTitle("Tracks"),o.refreshDataList({page:"#tracks",title:"Tracks",el:"#track-list",view:"track",template:$("#track-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/tracks?callback=?"),cacheKey:"/events/"+j+"/tracks",parse:function(a){return a}})},o.refreshTrack=function(a){f.resetFlashMessages("#track"),i.info("Refreshing track"),f.switchTitle("Track"),o.refreshDataList({page:"#track",title:"Track",el:"#track-presentation-list",view:"track",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",parse:function(b){return b=_(b).filter(function(b){return b.trackId==a}),_(b).each(function(a){a.language&&(a.language=a.language.toUpperCase()),a.favorite=q&&_(q.ids).contains(a.id)}),b},beforeReset:function(a){return _(a).each(function(a){a.favorite=q&&_(q.ids).contains(a.id)}),a},postRender:function(a){a.length>0&&f.switchTitle(a[0].get("track")),o.initSwipeFavorites("presentation-item")}})},o.refreshRooms=function(){f.resetFlashMessages("#rooms"),i.info("Refreshing rooms"),f.switchTitle("Salles"),o.refreshDataList({page:"#rooms",title:"Rooms",el:"#room-list",view:"room",template:$("#room-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/schedule/rooms?callback=?"),cacheKey:"/events/"+j+"/schedule/rooms",parse:function(a){return a}})},o.refreshRoom=function(a){f.resetFlashMessages("#room"),i.info("Refreshing room"),f.switchTitle("Room"),o.refreshDataList({page:"#room",title:"Room",el:"#room-presentation-list",view:"room",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+j+"/presentations?callback=?"),cacheKey:"/events/"+j+"/presentations",parse:function(b){return b=_(b).filter(function(b){return b.roomId==a}),_(b).each(function(a){a.language&&(a.language=a.language.toUpperCase()),a.favorite=q&&_(q.ids).contains(a.id)}),b},beforeReset:function(a){return _(a).each(function(a){a.favorite=q&&_(q.ids).contains(a.id)}),a},postRender:function(a){a.length>0&&f.switchTitle(a[0].get("room")),o.initSwipeFavorites("presentation-item")}})},o.refreshTwitter=function(a){_(n).contains(a)||(a=m),$(a===k?"#twitter-devoxxfr":"#twitter-xebiafr").removeClass("ui-btn-active"),$(a===k?"#twitter-xebiafr":"#twitter-devoxxfr").addClass("ui-btn-active"),console.log("Requested screen name : "+a),f.resetFlashMessages("#twitter"),i.info("Processing tweets"),$(".ui-title").html('<img src="image/twitter-white-transparent.png" class="twitter-header-img" style="height:18px;" />'),o.refreshDataList({page:"#twitter",title:"Twitter",el:"#twitter-timeline",view:"twitter",template:$("#twitter-timeline-tpl").html(),url:b.getTwitterFullUrl("/twitter/"+a+"?callback=?"),parse:function(a){return _(a).each(function(a){a.formattedDate=o.getTweetFormattedDate(a),a.user.icon=o.getTwitterUserImage(a.user),a.htmlText=o.twitter_linkify(a.text)}),a},postRender:function(a){}})},o.getTweetFormattedDate=function(a){return Date.parse(a.created_at)?Date.parse(a.created_at).toString("HH:mm"):"--:--"},o.getTwitterUserImage=function(a){return a.profile_image_url.replace(/_normal(\.[^\.]+)$/,"$1")},o.refreshXebiaProgram=function(a){f.resetFlashMessages("#xebia-program"),i.info("Refreshing Xebia Program"),o.refreshDataList({page:"#xebia-program",title:"Programme Xebia",el:"#xebia-program-list",view:"xebia-program",template:$("#xebia-program-list-tpl").html(),url:"http://devoxx-xebia.cloudfoundry.com/xebia/program?callback=?",cacheKey:"/xebia/program",parse:function(a){return a}})},o.twitter_linkify=function(a){return a=a.replace(/(https?:\/\/\S+)/gi,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"}),a=a.replace(/(^|)@(\w+)/gi,function(a){return'<a href="http://twitter.com/'+a+'" target="_blank">'+a+"</a>"}),a=a.replace(/(^|)#(\w+)/gi,function(a){return'<a href="http://search.twitter.com/search?q='+a.replace(/#/,"%23")+'" target="_blank">'+a+"</a>"}),a},o.formatPresentationSummary=function(a){return b.linkify(a.summary.replace(/\n/g,"<br />"))},o.initSwipeFavorites=function(a){$("ul li."+a).bind("swipeleft",function(a){var b=$(this),c=Number(b.attr("data-id"));_(q.ids).contains(c)&&(q.ids.splice(q.ids.indexOf(c),1),g.save("favorites",q),b.removeClass("ui-btn-up-e"),b.addClass("ui-btn-up-c"),b.attr("data-theme","c"))}),$("ul li."+a).bind("swiperight",function(a){var b=$(this),c=Number(b.attr("data-id"));_(q.ids).contains(c)||(q.ids.push(c),g.save("favorites",q),b.removeClass("ui-btn-up-c"),b.addClass("ui-btn-up-e"),b.attr("data-theme","e"))})},o.onFavoriteStarClick=function(a,b){a=Number(a);var c=_.contains(q.ids,a);c?q.ids.splice(q.ids.indexOf(a),1):q.ids.push(a),g.save("favorites",q),$(b).attr("src","image/star_"+(c?"empty":"plain")+".png")},i.info("Loaded core"),o.addUrlsForEvent(j),o})