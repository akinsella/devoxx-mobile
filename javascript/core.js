define(["log","utils","collection","entry","register","ui","db"],function(a,b,c,d,e,f,g){var h=a.getLogger("core");h.info("Loading core.js"),f.updateSplashscreenMessage("Chargement module core");var i="6",j="xebiaFr",k="devoxxFR",l=j,m=[j,k],n={},o,p={ids:[]};g.get("favorites",function(a){a&&(p=a.value)});var q={6:{1:"Mercredi 18 Avril",2:"Jeudi 19 Avril",3:"Vendredi 20 Avril"}};return n.setupRouter=function(){h.info("Instanciating jqmr router"),o=new $.mobile.Router({"#schedule":{handler:"onBeforeSchedulePageShow",events:"bs"},"#day(?:[?](.*))?":{handler:"onBeforeDayPageShow",events:"bs"},"#events":{handler:"onBeforeEventsPageShow",events:"bs"},"#event(?:[?](.*))?":{handler:"onBeforeEventPageShow",events:"bs"},"#rooms":{handler:"onBeforeRoomPageShow",events:"bs"},"#presentations":{handler:"onBeforePresentationsPageShow",events:"bs"},"#presentation(?:[?](.*))?":{handler:"onBeforePresentationPageShow",events:"bs"},"#speakers":{handler:"onBeforeSpeakersPageShow",events:"bs"},"#speaker(?:[?](.*))?":{handler:"onBeforeSpeakerPageShow",events:"bs"},"#tracks":{handler:"onBeforeTracksPageShow",events:"bs"},"#register":{handler:"onBeforeRegisterPageShow",events:"bs"},"#twitter(?:[?](.*))?":{handler:"onBeforeTwitterPageShow",events:"bs"},"#xebia-program":{handler:"onBeforeXebiaProgramPageShow",events:"bs"}},{onBeforeSchedulePageShow:function(a,b,c){n.refreshSchedule()},onBeforeEventsPageShow:function(a,b,c){n.refreshEvents()},onBeforeEventPageShow:function(a,b,c){var d=o.getParams(b[1]);n.refreshEvent(d.id)},onBeforeRoomPageShow:function(a,b,c){n.refreshRooms()},onBeforeTracksPageShow:function(a,b,c){n.refreshTracks()},onBeforePresentationsPageShow:function(a,b,c){n.refreshPresentations()},onBeforePresentationPageShow:function(a,b,c){var d=o.getParams(b[1]);n.refreshPresentation(d.id)},onBeforeSpeakersPageShow:function(a,b,c){n.refreshSpeakers()},onBeforeSpeakerPageShow:function(a,b,c){var d=o.getParams(b[1]);n.refreshSpeaker(d.id)},onBeforeDayPageShow:function(a,b,c){var d=o.getParams(b[1]);n.refreshDay(d.id)},onBeforeRegisterPageShow:function(a,b,c){e.beforePageShow()},onBeforeTwitterPageShow:function(a,b,c){var d=o.getParams(b[1]),e=d?d.screenname:undefined;n.refreshTwitter(e)},onBeforeXebiaProgramPageShow:function(a,b,c){n.refreshXebiaProgram()}}),h.info("Instanciated jqmr router")},n.onFetchSuccess=function(a,b,c){a.get("statusCode")=="404"&&f.showFlashMessage(_.extend({type:"error",message:a.get("message")},c)),setTimeout(function(){$.mobile.hidePageLoadingMsg(),f.hideFlashMessage(c)},0)},n.onFetchError=function(a,b,c,d){setTimeout(function(){h.info("Error response tmp: '"+b+"' for url: '"+d.fetchUrl+"'"),$.mobile.hidePageLoadingMsg(),f.hideFlashMessage(d),f.showFlashMessage(_.extend({type:"error",message:"No data found ..."},d))},0)},n.getParams=function(a){if(!a)return null;var b={},c,d=a.slice(a.indexOf("?")+1).split("&");return $.each(d,function(a,d){c=d.split("="),b[c[0]]?(b[c[0]]instanceof Array||(b[c[0]]=[b[c[0]]]),b[c[0]].push(c[1])):b[c[0]]=c[1]}),$.isEmptyObject(b)?null:b},n.refreshDataList=function(a){$.mobile.showPageLoadingMsg(),h.info("Show "+a.title+" page message!"),f.showFlashMessage(a),h.info("Loading "+a.title+" View"),c.views[a.view]=new c.EntryListView({fetchUrl:a.url,el:a.el,collectionTemplate:a.template,parse:a.parse,beforeParse:a.beforeParse,view:a.view,postRender:a.postRender,afterParse:function(b){a.cacheKey&&!b.statusCode&&g.save(a.cacheKey,b),a.afterParse&&a.afterParse(b)}}),c.views[a.view].collection.length!==0&&c.views[a.view].collection.reset([]),h.info("Fetch "+a.title+" Data from url: '"+c.views[a.view].collection.url+"'");var b={success:function(b,c){a.success&&a.success(b,c),n.onFetchSuccess(b,c,a)},error:function(b,c,d){n.onFetchError(b,c,d,a)},fetchUrl:a.url};g.getOrFetch(a.cacheKey,function(b){a.beforeReset&&a.beforeReset(b),c.views[a.view].collection.reset(b),f.hideFlashMessage(a)},function(){c.views[a.view].el.empty(),c.views[a.view].collection.fetch(b)})},n.refreshDataEntry=function(a){$.mobile.showPageLoadingMsg(),h.info("Show "+a.title+" page message!"),f.showFlashMessage(a),h.info("Loading "+a.title+" View"),d.views[a.view]=new d.EntryView({fetchUrl:a.url,el:a.el,entryTemplate:a.template,parse:a.parse,beforeParse:a.beforeParse,postRender:a.postRender,view:a.view,afterParse:function(b){a.cacheKey&&!b.statusCode&&g.save(a.cacheKey,b),a.afterParse&&a.afterParse(b)}}),d.views[a.view].entry&&d.views[a.view].entry.clear(),h.info("Fetch "+a.title+" Data from url: '"+d.views[a.view].entry.url+"'");var b={success:function(b,c){a.success&&a.success(b,c),n.onFetchSuccess(b,c,a)},error:function(b,c,d){n.onFetchError(b,c,d,a)},fetchUrl:a.url};g.getOrFetch(a.cacheKey,function(b){a.beforeReset&&a.beforeReset(b),d.views[a.view].entry.set(b),f.hideFlashMessage(a)},function(){d.views[a.view].entry.fetch(b)})},n.refreshSchedule=function(){f.resetFlashMessages("#schedule"),f.switchTitle("Planning"),n.refreshDataList({page:"#schedule",title:"Planning",el:"#schedule-list",view:"schedule",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/events/"+i+"/schedule?callback=?"),cacheKey:"/events/"+i+"/schedule",parse:function(a){return _.each(a,function(a){a.presentationUri&&(a.key=Number(a.presentationUri.substring(a.presentationUri.lastIndexOf("/")+1)),a.favorite=p&&_(p.ids).contains(a.key)),a.startTime=n.getScheduleTime(a.fromTime),a.endTime=n.getScheduleTime(a.toTime)}),a},beforeReset:function(a){return _.each(a,function(a){a.presentationUri&&(a.favorite=p&&_(p.ids).contains(Number(a.key)))}),a},postRender:function(a){n.initSwipeFavorites("presentation-schedule-item")}})},n.refreshDay=function(a){f.resetFlashMessages("#day"),h.info("Processing day: "+a);var c="Jour "+a;q[i]&&q[i][a]&&(c=q[i][a]),f.switchTitle(c),n.refreshDataList({page:"#day",title:c,el:"#day-list",view:"day",template:$("#schedule-list-tpl").html(),url:b.getFullUrl("/events/"+i+"/schedule/day/"+a+"?callback=?"),cacheKey:"/events/"+i+"/schedule/day/"+a,parse:function(a){return _.each(a,function(a){a.presentationUri&&(a.key=a.presentationUri.substring(a.presentationUri.lastIndexOf("/")+1),a.favorite=p&&_(p.ids).contains(Number(a.key))),a.startTime=n.getScheduleTime(a.fromTime),a.endTime=n.getScheduleTime(a.toTime)}),a},beforeReset:function(a){return _.each(a,function(a){a.presentationUri&&(a.favorite=p&&_(p.ids).contains(Number(a.key)))}),a},postRender:function(a){n.initSwipeFavorites("presentation-day-item")}})},n.getScheduleTime=function(a){return Date.parseExact(a.substring(0,a.lastIndexOf(".")),"yyyy-MM-dd HH:mm:ss").toString("HH:mm")},n.refreshEvents=function(){f.resetFlashMessages("#events"),h.info("Refreshing events"),f.switchTitle("Evénements"),n.refreshDataList({page:"#events",title:"Event",el:"#event-list",view:"events",template:$("#event-list-tpl").html(),url:b.getFullUrl("/events?callback=?"),cacheKey:"/events",parse:function(a){return a}})},n.refreshEvent=function(a){f.resetFlashMessages("#event"),h.info("Processing event: "+a),f.switchTitle("Evénement"),n.refreshDataEntry({page:"#event",title:"Event",el:"#event-content",view:"event",template:$("#event-tpl").html(),url:b.getFullUrl("/events/"+a+"?callback=?"),cacheKey:"/events/"+a,parse:function(a){return a},postRender:function(a){$("#event-details-list").listview(),f.switchTitle(a.get("name"))}})},n.refreshPresentations=function(){f.resetFlashMessages("#presentations"),h.info("Refreshing presentations"),f.switchTitle("Présentations"),n.refreshDataList({page:"#presentations",title:"Presentations",el:"#presentation-list",view:"presentation",template:$("#presentation-list-tpl").html(),url:b.getFullUrl("/events/"+i+"/presentations?callback=?"),cacheKey:"/events/"+i+"/presentations",parse:function(a){return _.each(a,function(a){a.favorite=p&&_(p.ids).contains(a.id)}),a},beforeReset:function(a){return _.each(a,function(a){a.favorite=p&&_(p.ids).contains(a.id)}),a},postRender:function(a){n.initSwipeFavorites("presentation-item")}})},n.refreshPresentation=function(a){f.resetFlashMessages("#presentation"),h.info("Processing presentation: "+a),f.switchTitle("Présentation"),n.refreshDataEntry({page:"#presentation",title:"Présentation",el:"#presentation-content",view:"presentation",template:$("#presentation-tpl").html(),url:b.getFullUrl("/events/presentations/"+a+"?callback=?"),cacheKey:"/events/presentations/"+a,parse:function(a){return a.favorite=p&&_.contains(p.ids,a.id),_.each(a.speakers,function(a){a.id=a.speakerUri.substring(a.speakerUri.lastIndexOf("/")+1)}),a},postRender:function(a){$("#presentation-tag-list").listview(),$("#presentation-speaker-list").listview(),$("#presentation-details-list").listview(),f.switchTitle(a.get("title"))},beforeReset:function(a){return a.favorite=p&&_.contains(p.ids,a.id),a}})},n.refreshRooms=function(){f.resetFlashMessages("#rooms"),h.info("Refreshing rooms"),f.switchTitle("Salles"),n.refreshDataList({page:"#rooms",title:"Rooms",el:"#room-list",view:"room",template:$("#room-list-tpl").html(),url:b.getFullUrl("/events/"+i+"/schedule/rooms?callback=?"),cacheKey:"/events/"+i+"/schedule/rooms",parse:function(a){return a}})},n.refreshTracks=function(){f.resetFlashMessages("#tracks"),h.info("Refreshing tracks"),f.switchTitle("Tracks"),n.refreshDataList({page:"#tracks",title:"Tracks",el:"#track-list",view:"track",template:$("#track-list-tpl").html(),url:b.getFullUrl("/events/"+i+"/tracks?callback=?"),cacheKey:"/events/"+i+"/tracks",parse:function(a){return a}})},n.refreshSpeakers=function(){f.resetFlashMessages("#tracks"),h.info("Refreshing speakers"),f.switchTitle("Speakers"),n.refreshDataList({page:"#speakers",title:"Speakers",el:"#speaker-list",view:"speaker",template:$("#speaker-list-tpl").html(),url:b.getFullUrl("/events/"+i+"/speakers?callback=?"),cacheKey:"/events/"+i+"/speakers",parse:function(a){return a}})},n.refreshSpeaker=function(a){f.resetFlashMessages("#speaker"),h.info("Processing speaker: "+a),f.switchTitle("Speaker"),n.refreshDataEntry({page:"#speaker",title:"Speaker",el:"#speaker-content",view:"speaker",template:$("#speaker-tpl").html(),url:b.getFullUrl("/events/speakers/"+a+"?callback=?"),cacheKey:"/events/speakers/"+a,parse:function(a){return _.each(a.talks,function(a){a.id=a.presentationUri.substring(a.presentationUri.lastIndexOf("/")+1)}),a},postRender:function(a){$("#speaker-details-list").listview(),$("#speaker-talk-list").listview();var b=a.get("firstName")?a.get("firstName"):"";b+=a.get("firstName")&&a.get("lastName")?" ":"",b+=a.get("lastName")?a.get("lastName"):"",f.switchTitle(b?b:"Speaker")}})},n.refreshTwitter=function(a){_(m).contains(a)||(a=l),$(a===j?"#twitter-devoxxfr":"#twitter-xebiafr").removeClass("ui-btn-active"),$(a===j?"#twitter-xebiafr":"#twitter-devoxxfr").addClass("ui-btn-active"),console.log("Requested screen name : "+a),f.resetFlashMessages("#twitter"),h.info("Processing tweets"),$(".ui-title").html('<img src="image/twitter-white-transparent.png" class="twitter-header-img" style="height:18px;" />'),n.refreshDataList({page:"#twitter",title:"Twitter",el:"#twitter-timeline",view:"twitter",template:$("#twitter-timeline-tpl").html(),url:OFFLINE?b.getFullUrl("/twitter/"+a+"?callback=?"):"http://api.twitter.com/1/statuses/user_timeline.json?screen_name="+a+"&contributor_details=false&include_entities=false&include_rts=true&exclude_replies=true&count=50&exclude_replies=false&callback=?",parse:function(a){return _(a).each(function(a){a.formattedDate=Date.parse(a.created_at)?Date.parse(a.created_at).toString("HH:mm"):"--:--";var b=a.user.profile_image_url.replace(/_normal(\.[^\.]+)$/,"$1");a.user.icon=b,a.htmlText=n.twitter_linkify(a.text)}),a},postRender:function(a){console.log("post render")}})},n.refreshXebiaProgram=function(a){f.resetFlashMessages("#xebia-program"),h.info("Refreshing Xebia Program"),n.refreshDataList({page:"#xebia-program",title:"Programme Xebia",el:"#xebia-program-list",view:"xebia-program",template:$("#xebia-program-list-tpl").html(),url:"http://devoxx-xebia.cloudfoundry.com/xebia/program?callback=?",cacheKey:"/xebia/program",parse:function(a){return a}})},n.twitter_linkify=function(a){return a=a.replace(/(https?:\/\/\S+)/gi,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"}),a=a.replace(/(^|)@(\w+)/gi,function(a){return'<a href="http://twitter.com/'+a+'" target="_blank">'+a+"</a>"}),a=a.replace(/(^|)#(\w+)/gi,function(a){return'<a href="http://search.twitter.com/search?q='+a.replace(/#/,"%23")+'" target="_blank">'+a+"</a>"}),a},n.initSwipeFavorites=function(a){$("ul li."+a).bind("swipeleft",function(a){var b=$(this),c=Number(b.attr("data-id"));_(p.ids).contains(c)&&(p.ids.splice(p.ids.indexOf(c),1),g.save("favorites",p),b.removeClass("ui-btn-up-e"),b.addClass("ui-btn-up-c"),b.attr("data-theme","c"))}),$("ul li."+a).bind("swiperight",function(a){var b=$(this),c=Number(b.attr("data-id"));_(p.ids).contains(c)||(p.ids.push(c),g.save("favorites",p),b.removeClass("ui-btn-up-c"),b.addClass("ui-btn-up-e"),b.attr("data-theme","e"))})},n.onFavoriteStarClick=function(a,b){a=Number(a);var c=_.contains(p.ids,a);c?p.ids.splice(p.ids.indexOf(a),1):p.ids.push(a),g.save("favorites",p),$(b).attr("src","image/star_"+(c?"empty":"plain")+".png")},h.info("Loaded core"),n})